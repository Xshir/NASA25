<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NASA_2025 — Event Weather Planner</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #0b0c10 0%, #1f2833 100%);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      height: 100vh;
      margin: 0;
      padding: 1.5rem;
    }
    h1 { margin-bottom: 0.3rem; color: #66fcf1; }
    h2 { color: #45a29e; margin-top: 1.2rem; }
    input, button {
      padding: 0.6rem;
      border-radius: 6px;
      border: none;
      margin: 0.3rem 0;
      font-size: 1rem;
    }
    input { width: 100%; max-width: 320px; }
    button {
      cursor: pointer;
      background-color: #45a29e;
      color: #0b0c10;
      font-weight: 600;
    }
    button:hover { background-color: #66fcf1; }
    .card {
      background: #1f2833;
      border-radius: 10px;
      padding: 1.5rem 1.8rem;
      margin: 1rem 0;
      width: 100%;
      max-width: 460px;
      box-shadow: 0 0 12px rgba(102, 252, 241, 0.3);
    }
    .hidden { display: none; }
    .list { margin-top: .5rem; }
    .list-item {
      display: flex; justify-content: space-between; align-items: center;
      gap: .6rem; padding: .6rem .4rem; border-bottom: 1px solid #2b3442;
    }
    .list-item button {
      padding: .4rem .6rem; font-size: .9rem;
    }
    #weatherBar {
      position: fixed;
      bottom: 0;
      width: 100%;
      text-align: center;
      padding: 0.8rem;
      background: rgba(31, 40, 51, 0.95);
      border-top: 1px solid #45a29e;
      font-size: 0.9rem;
    }
    #logoutBtn { margin-top: 1rem; background-color: #c0392b; color: #fff; }
    #logoutBtn:hover { background-color: #e74c3c; }
    ul.tips { padding-left: 1.2rem; }
    ul.tips li { margin: .25rem 0; }
    .muted { color:#a8b3d1; font-size:.95rem; }
  </style>
</head>
<body>
  <h1>NASA_2025</h1>
  <p class="muted">Plan your perfect event — powered by NASA & Meteomatics</p>

  <!-- LOGIN PAGE -->
  <div id="loginCard" class="card">
    <h2>Login</h2>
    <input id="loginUsername" placeholder="Username" autocomplete="off" />
    <input id="loginPin" placeholder="4-digit PIN" maxlength="4" inputmode="numeric" type="password" />
    <button onclick="login()">Login</button>
    <p id="loginMsg"></p>
    <p>Don’t have an account? <a href="#" onclick="showSignup()">Sign up</a></p>
  </div>

  <!-- SIGNUP PAGE -->
  <div id="signupCard" class="card hidden">
    <h2>Sign Up</h2>
    <input id="signupUsername" placeholder="Choose username" autocomplete="off" />
    <input id="signupPin" placeholder="4-digit PIN" maxlength="4" inputmode="numeric" type="password" />
    <button onclick="signup()">Create Account</button>
    <p id="signupMsg"></p>
    <p>Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
  </div>

  <!-- MAIN DASHBOARD -->
  <div id="mainCard" class="card hidden">
    <h2>Create Event</h2>
    <input id="eventName" placeholder="Event name (e.g., Picnic, Flying Drone)" />
    <input id="eventDate" type="date" />
    <input id="eventCity" placeholder="City (auto-detected or type manually)" />
    <button onclick="planEvent()">Plan Event</button>
    <p id="eventMsg"></p>

    <h2>Your Events</h2>
    <div id="eventsList" class="list"></div>

    <button id="logoutBtn" onclick="logout()">Logout</button>
  </div>

  <!-- EVENT DETAILS PAGE -->
  <div id="eventCard" class="card hidden">
    <button onclick="showMain()" style="float:right;">← Back</button>
    <h2 id="eventTitle">Event</h2>
    <p id="eventSub" class="muted">Date & Location</p>
    <h3>Suggested prep</h3>
    <p id="eventHeadline" style="margin:.2rem 0 0.6rem;"></p>
    <ul id="eventTips" class="tips"></ul>
    <p class="muted" id="eventNote"></p>
  </div>

  <div id="weatherBar">Detecting location & weather...</div>

  <script>
    const API_BASE = "";
    let TOKEN = localStorage.getItem("token") || null;

    // Simple router helpers
    function hideAll() { document.querySelectorAll(".card").forEach(c => c.classList.add("hidden")); }
    function showLogin()  { hideAll(); document.getElementById("loginCard").classList.remove("hidden"); }
    function showSignup() { hideAll(); document.getElementById("signupCard").classList.remove("hidden"); }
    function showMain()   { hideAll(); document.getElementById("mainCard").classList.remove("hidden"); fetchEvents(); }
    function showEvent()  { hideAll(); document.getElementById("eventCard").classList.remove("hidden"); }

    window.addEventListener("load", () => {
      if (TOKEN) showMain(); else showLogin();
      getWeatherBar();
    });

    // ---------------- AUTH ----------------
    async function signup() {
      const username = document.getElementById("signupUsername").value.trim().toLowerCase();
      const pin = document.getElementById("signupPin").value.trim();
      const res = await fetch(`${API_BASE}/signup`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, pin }),
      });
      const data = await res.json();
      if (data.ok) { TOKEN = data.token; localStorage.setItem("token", TOKEN); showMain(); }
      else { document.getElementById("signupMsg").textContent = data.error || "Signup failed"; }
    }

    async function login() {
      const username = document.getElementById("loginUsername").value.trim().toLowerCase();
      const pin = document.getElementById("loginPin").value.trim();
      const res = await fetch(`${API_BASE}/login`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, pin }),
      });
      const data = await res.json();
      if (data.ok) { TOKEN = data.token; localStorage.setItem("token", TOKEN); showMain(); }
      else { document.getElementById("loginMsg").textContent = data.error || "Login failed"; }
    }

    function logout() { TOKEN = null; localStorage.removeItem("token"); showLogin(); }

    // ------------- EVENTS (list + create) -------------
    async function planEvent() {
      const name = document.getElementById("eventName").value.trim();
      const date = document.getElementById("eventDate").value;
      const city = document.getElementById("eventCity").value.trim();
      const msg = document.getElementById("eventMsg");

      if (!name || !date) { msg.textContent = "Enter event name and date"; return; }

      msg.textContent = "Saving…";
      const body = { event_name: name, city, date };
      if (window.currentCoords) { body.lat = window.currentCoords.lat; body.lon = window.currentCoords.lon; }

      try {
        const res = await fetch(`${API_BASE}/events`, {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${TOKEN}` },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (res.ok && data.id) {
          msg.textContent = "Event added ✅";
          document.getElementById("eventName").value = "";
          document.getElementById("eventDate").value = "";
          await fetchEvents();
        } else {
          msg.textContent = "Error: " + (data.error || "Unknown");
          console.error("create failed:", data);
        }
      } catch (e) {
        msg.textContent = "Network error";
        console.error(e);
      }
    }

    async function fetchEvents() {
      const res = await fetch(`${API_BASE}/events`, { headers: { Authorization: `Bearer ${TOKEN}` } });
      const data = await res.json();
      const list = document.getElementById("eventsList");
      list.innerHTML = "";
      if (!Array.isArray(data) || data.length === 0) {
        list.textContent = "No events yet.";
        return;
      }
      data.forEach(e => {
        const row = document.createElement("div");
        row.className = "list-item";
        const title = document.createElement("div");
        title.textContent = `${e.event_name} — ${e.date}`;
        const btn = document.createElement("button");
        btn.textContent = "View";
        btn.onclick = () => openEventDetails(e);
        row.appendChild(title);
        row.appendChild(btn);
        list.appendChild(row);
      });
    }

    // --------- EVENT DETAILS (separate screen) ---------
    async function openEventDetails(e) {
      // Fill header
      document.getElementById("eventTitle").textContent = e.event_name;
      document.getElementById("eventSub").textContent = `${e.date}${e.city ? " • " + e.city : ""}`;
      // Fetch suggestions for this event
      const res = await fetch(`${API_BASE}/suggest`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${TOKEN}` },
        body: JSON.stringify({ event_name: e.event_name, date: e.date, lat: e.lat, lon: e.lon }),
      });
      const data = await res.json();
      document.getElementById("eventHeadline").textContent = `Predicted weather: ${data.predicted || "—"}`;
      const tips = document.getElementById("eventTips"); tips.innerHTML = "";
      (data.advice || []).forEach(t => {
        const li = document.createElement("li"); li.textContent = t; tips.appendChild(li);
      });
      document.getElementById("eventNote").textContent = data.note || "";
      // Show screen
      showEvent();
    }

    // ---------------- WEATHER BAR ----------------
    async function getWeatherBar() {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          window.currentCoords = { lat: latitude, lon: longitude };
          document.getElementById("weatherBar").textContent =
            `Location: (${latitude.toFixed(2)}, ${longitude.toFixed(2)}) — live weather to be added`;
        },
        () => {
          document.getElementById("weatherBar").textContent =
            "Location access denied — please type your city manually.";
        }
      );
    }
  </script>
</body>
</html>
