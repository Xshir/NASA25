<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NASA_2025 ‚Äî Event Weather Planner</title>
  <style>
    :root{
      --bg1:#07090e; --bg2:#0f1624;
      --panel:#121a27; --panel-2:#1b2636;
      --teal:#66fcf1; --mint:#45a29e;
      --muted:#b7c3dc; --stroke:#2d3a4d; --accent:#2b3442;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
      margin:0; color:#eaf5ff;
      background:
        radial-gradient(1200px 600px at 10% -10%, #0a1930 0%, transparent 60%),
        radial-gradient(1000px 500px at 90% 110%, #08212f 0%, transparent 55%),
        linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 100%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    #app{ min-height:100dvh; display:flex; flex-direction:column; align-items:center; padding:24px 16px 72px; transition:filter .25s ease, opacity .25s ease; }
    #app.blurred{ filter:blur(12px) saturate(85%) brightness(.85); }

    h1{color:var(--teal); margin:.2rem 0 .3rem; letter-spacing:.4px}
    h2{color:var(--mint); margin:1rem 0 .6rem}
    .muted{color:var(--muted)}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(6px);
      width:min(95vw,760px);
      border-radius:14px; padding:18px 20px; margin:12px 0;
      box-shadow:0 12px 36px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02);
      transition:transform .05s ease;
    }
    .card:active{transform:translateY(1px)}
    .hidden{display:none}

    .header{ display:grid; grid-template-columns:1fr auto auto; gap:12px; align-items:center;
      padding:12px 14px; border-radius:14px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); }
    .time{font-size:1.25rem; font-weight:700}
    .loc{font-size:.95rem; color:var(--muted)}
    .wx{font-size:.95rem; opacity:.9}

    .btn{ padding:.55rem .9rem; border:none; border-radius:10px; cursor:pointer; font-weight:700; font-size:.95rem;
      transition:transform .05s ease, background .2s ease, box-shadow .2s ease; box-shadow:none; }
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--mint); color:#0b0c10;}
    .btn-primary:hover{background:var(--teal); box-shadow:0 10px 24px rgba(102,252,241,.25);}
    .btn-ghost{background:#223043; color:#e6f7f6; border:1px solid var(--stroke)}
    .btn-ghost:hover{background:#2a3b53; box-shadow:0 10px 24px rgba(0,0,0,.25);}

    .list{margin-top:.5rem}
    .item{ display:grid; grid-template-columns:1fr auto; gap:.6rem; align-items:center;
      padding:.7rem .35rem; border-bottom:1px solid rgba(255,255,255,.06); }
    .item-title{font-weight:700; letter-spacing:.2px}
    .item-sub{color:var(--muted); font-size:.95rem}
    .btn-row{display:flex; gap:.45rem}

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1000;
      background:rgba(9,14,22,.55); animation:fadeIn .18s ease; }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .sheet{ background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10); border-radius:16px; width:min(92vw,560px); padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); }
    .row{display:grid; gap:.9rem}
    .row-2{grid-template-columns:1fr 1fr}
    label{font-size:.92rem; color:var(--muted); display:block; margin:.2rem 0 .35rem}
    input,select{ width:100%; padding:.65rem .75rem; border:1px solid var(--stroke); border-radius:10px;
      background:#0f1928; color:#fff; font-size:1rem; outline:none; box-shadow:0 3px 0 rgba(0,0,0,.25) inset; }
    .date-line{display:flex; align-items:center; gap:.8rem}
    .date-label{min-width:150px; color:var(--muted)}
    .date-wrap{position:relative; width:46px; height:46px}
    .icon-btn{ width:46px; height:46px; border-radius:12px; background:#213247; border:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:center; }
    .icon-btn:hover{background:#2a3b53}
    .date-overlay{position:absolute; inset:0; opacity:0; cursor:pointer}
    .calendar-emoji{font-size:20px}
    #cityOther{margin-top:.4rem}

    /* Gate & bottom bar */
    #gate{ position:fixed; inset:0; background:rgba(5,10,18,.92); display:none; align-items:center; justify-content:center; z-index:1500; }
    #gate .panel{ background:var(--panel-2); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:24px; width:min(92vw,520px); }
    #gate ul{margin:.5rem 0 .75rem 1.2rem}
    #weatherBar{ position:fixed; bottom:0; left:0; right:0; text-align:center; padding:.55rem; border-top:1px solid rgba(255,255,255,.08); background:rgba(18,27,41,.92); font-size:.92rem }
  </style>
</head>
<body>
  <div id="app">
    <h1>NASA_2025</h1>
    <p class="muted" style="margin-top:-2px;">Plan your perfect event ‚Äî powered by NASA & Meteomatics</p>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h2>Login</h2>
      <div class="row">
        <input id="loginUsername" placeholder="Username" autocomplete="off" />
        <input id="loginPin" placeholder="4-digit PIN" maxlength="4" inputmode="numeric" type="password" />
        <button class="btn btn-primary" onclick="login()">Login</button>
        <p id="loginMsg"></p>
        <p class="muted">Don‚Äôt have an account? <a href="#" onclick="showSignup()" style="color:var(--teal); text-decoration:none">Sign up</a></p>
      </div>
    </div>

    <!-- SIGNUP -->
    <div id="signupCard" class="card hidden">
      <h2>Sign Up</h2>
      <div class="row">
        <input id="signupUsername" placeholder="Choose username" autocomplete="off" />
        <input id="signupPin" placeholder="4-digit PIN" maxlength="4" inputmode="numeric" type="password" />
        <button class="btn btn-primary" onclick="signup()">Create Account</button>
        <p id="signupMsg"></p>
        <p class="muted">Already have an account? <a href="#" onclick="showLogin()" style="color:var(--teal); text-decoration:none">Login</a></p>
      </div>
    </div>

    <!-- HOME -->
    <div id="homeCard" class="card hidden">
      <div class="header">
        <div>
          <div class="time" id="clock">--:--</div>
          <div class="loc" id="locLine">Locating‚Ä¶</div>
        </div>
        <div class="wx" id="wxNow">Weather: (coming soon)</div>
        <button class="btn btn-primary" onclick="openPlanner('create')">Plan</button>
      </div>

      <h2 style="margin-top:1rem;">Upcoming Events</h2>
      <div id="eventsList" class="list"></div>

      <div style="margin-top:12px; display:flex; justify-content:flex-end;">
        <button class="btn btn-ghost" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- EVENT DETAILS -->
    <div id="eventCard" class="card hidden">
      <button onclick="showHome()" class="btn btn-ghost" style="float:right;">‚Üê Back</button>
      <h2 id="eventTitle">Event</h2>
      <p id="eventSub" class="muted">Date & Location</p>
      <h3>Suggested prep</h3>
      <p id="eventHeadline" style="margin:.2rem 0 .6rem;"></p>
      <ul id="eventTips"></ul>
      <p class="muted" id="eventNote"></p>
    </div>
  </div>

  <!-- Planner modal -->
  <div id="planner" class="modal">
    <div class="sheet">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 id="plannerTitle">Plan New Event</h2>
        <button class="btn btn-ghost" onclick="closePlanner()">‚úï</button>
      </div>

      <div class="row">
        <div>
          <label for="eventName">Event name</label>
          <input id="eventName" />
        </div>

        <div>
          <label>Date</label>
          <div class="date-line">
            <span class="date-label" id="dateLabel">No date selected</span>
            <div class="date-wrap">
              <button class="icon-btn" title="Pick date"><span class="calendar-emoji">üìÖ</span></button>
              <input id="eventDate" type="date" class="date-overlay" />
            </div>
          </div>
        </div>

        <div class="row row-2">
          <div>
            <label for="countrySelect">Country</label>
            <select id="countrySelect"></select>
          </div>
          <div>
            <label for="citySelect">City</label>
            <select id="citySelect"></select>
            <input id="cityOther" class="hidden" placeholder="Enter city" />
          </div>
        </div>

        <div style="display:flex; gap:.6rem; justify-content:flex-end; margin-top:.4rem;">
          <button class="btn btn-ghost" onclick="closePlanner()">Cancel</button>
          <button id="saveBtn" class="btn btn-primary" onclick="saveEvent()">Save</button>
        </div>

        <p id="eventMsg"></p>
      </div>
    </div>
  </div>

  <!-- Location gate (persistent guidance + auto-retry) -->
  <div id="gate">
    <div class="panel">
      <h2>Location is required</h2>
      <p class="muted">We need your location to tailor weather guidance for your plans.</p>
      <ul class="muted">
        <li>If you previously selected <b>Block</b>, please allow location for this site in your browser settings.</li>
        <li>After changing the setting, return here and click <b>Try again</b>.</li>
      </ul>
      <div style="display:flex; gap:.5rem; flex-wrap:wrap">
        <button class="btn btn-primary" onclick="ensureGeoPermission()">Try again</button>
        <button class="btn btn-ghost" onclick="openHelp()">How to allow</button>
        <button class="btn btn-ghost" onclick="location.reload()">Reload</button>
      </div>
      <p id="gateMsg" class="muted" style="margin-top:.6rem;"></p>
    </div>
  </div>

  <div id="weatherBar">Requesting location permission‚Ä¶</div>

  <script>
    // -------------------- Global & Router --------------------
    const API_BASE = "";
    let TOKEN = localStorage.getItem("token") || null;
    let currentDateISO = "";
    let plannerMode = "create"; // or "edit"
    let editingId = null;

    function hideAll(){ document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden")); }
    function showLogin(){ hideAll(); document.getElementById("loginCard").classList.remove("hidden"); }
    function showSignup(){ hideAll(); document.getElementById("signupCard").classList.remove("hidden"); }
    function showHome(){ hideAll(); document.getElementById("homeCard").classList.remove("hidden"); fetchEvents(); }
    function showEvent(){ hideAll(); document.getElementById("eventCard").classList.remove("hidden"); }

    window.addEventListener("load", () => {
      tickClock(); setInterval(tickClock, 1000);
      ensureGeoPermission();      // <-- new
      if (TOKEN) showHome(); else showLogin();
      wireDatePicker();
    });

    // -------------------- Auth --------------------
    async function signup(){
      const username = document.getElementById("signupUsername").value.trim().toLowerCase();
      const pin = document.getElementById("signupPin").value.trim();
      const r = await fetch(`${API_BASE}/signup`, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({username,pin})});
      const data = await r.json();
      if(data.ok){ TOKEN=data.token; localStorage.setItem("token",TOKEN); showHome(); }
      else document.getElementById("signupMsg").textContent=data.error||"Signup failed";
    }
    async function login(){
      const username = document.getElementById("loginUsername").value.trim().toLowerCase();
      const pin = document.getElementById("loginPin").value.trim();
      const r = await fetch(`${API_BASE}/login`, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({username,pin})});
      const data = await r.json();
      if(data.ok){ TOKEN=data.token; localStorage.setItem("token",TOKEN); showHome(); }
      else document.getElementById("loginMsg").textContent=data.error||"Login failed";
    }
    function logout(){ TOKEN=null; localStorage.removeItem("token"); showLogin(); }

    // -------------------- Clock --------------------
    function tickClock(){
      const now = new Date();
      const hh = now.getHours().toString().padStart(2,"0");
      const mm = now.getMinutes().toString().padStart(2,"0");
      document.getElementById("clock").textContent = `${hh}:${mm}`;
    }

    // -------------------- Geolocation with auto-retry --------------------
    async function ensureGeoPermission(){
      // Use Permissions API where available
      const gateMsg = document.getElementById("gateMsg");
      try{
        if (navigator.permissions && navigator.permissions.query){
          const status = await navigator.permissions.query({name:"geolocation"});
          // react immediately and on future changes
          const apply = () => {
            if (status.state === "granted") { hideGate(); requestLocation(); }
            else if (status.state === "prompt") { hideGate(); requestLocation(true); } // will show native prompt
            else { showGate(); gateMsg.textContent = "Location is blocked for this site. Please allow it in your browser settings, then click Try again."; }
          };
          status.onchange = apply;
          apply();
        } else {
          // Older browsers: just try; if denied, fall back to gate
          requestLocation(true);
        }
      }catch(e){
        // Fallback to simple attempt
        requestLocation(true);
      }
    }

    function requestLocation(spawnPrompt=false){
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const {latitude, longitude} = pos.coords;
        window.currentCoords = {lat:latitude, lon:longitude};
        document.getElementById("weatherBar").textContent = `Location: (${latitude.toFixed(2)}, ${longitude.toFixed(2)})`;
        hideGate();
        await prefillLocation(latitude, longitude);
      }, (err)=>{
        if (err && err.code === err.PERMISSION_DENIED){
          // If user denied, show gate and wait for them to change site permission.
          showGate();
          document.getElementById("gateMsg").textContent = "Permission denied. Allow location for this site, then press Try again.";
        } else {
          showGate();
          document.getElementById("gateMsg").textContent = "Unable to get location. Please try again.";
        }
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    }

    function openHelp(){
      // Open helpful docs based on browser (best-effort)
      const ua = navigator.userAgent.toLowerCase();
      let url = "https://support.google.com/chrome/answer/142065?hl=en"; // default: Chrome help
      if (ua.includes("firefox")) url = "https://support.mozilla.org/en-US/kb/site-permissions";
      else if (ua.includes("safari") && !ua.includes("chrome")) url = "https://support.apple.com/guide/safari/safo40501/mac";
      else if (ua.includes("edg/")) url = "https://support.microsoft.com/topic/manage-location-permissions-in-microsoft-edge";
      window.open(url, "_blank");
    }

    async function prefillLocation(lat,lon){
      try{
        const r = await fetch(`/reverse_geocode?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`);
        const data = await r.json();
        const loc = [data.city, data.country].filter(Boolean).join(", ");
        document.getElementById("locLine").textContent = loc || "Location detected";
        populateCountry(data.country||"");
        populateCity(data.city||"");
      }catch(e){
        populateCountry(""); populateCity("");
      }
    }
    function showGate(){ document.getElementById("gate").style.display="flex"; }
    function hideGate(){ document.getElementById("gate").style.display="none"; }

    // -------------------- Planner (Create/Edit) --------------------
    function openPlanner(mode="create", ev=null){
      plannerMode = mode;
      editingId = ev?.id ?? null;
      document.getElementById("plannerTitle").textContent = mode==="edit" ? "Edit Event" : "Plan New Event";
      document.getElementById("eventMsg").textContent = "";

      document.getElementById("eventName").value = ev?.event_name || "";
      currentDateISO = ev?.date || "";
      document.getElementById("eventDate").value = currentDateISO;
      setDateLabel(currentDateISO);

      populateCity(ev?.city || document.getElementById("citySelect").value);
      if (ev?.city) {
        const sel = document.getElementById("citySelect");
        let found=false; [...sel.options].forEach(o=>{ if(o.value===ev.city){ o.selected=true; found=true; }});
        if(!found){ sel.value="__OTHER__"; document.getElementById("cityOther").classList.remove("hidden"); document.getElementById("cityOther").value = ev.city; }
      }

      document.getElementById("planner").style.display = "flex";
      document.getElementById("app").classList.add("blurred");
    }
    function closePlanner(){
      document.getElementById("planner").style.display = "none";
      document.getElementById("app").classList.remove("blurred");
      document.getElementById("cityOther").classList.add("hidden");
      document.getElementById("cityOther").value="";
    }

    async function saveEvent(){
      const name = document.getElementById("eventName").value.trim();
      const date = currentDateISO || document.getElementById("eventDate").value;
      const city = chosenCity();
      const msg = document.getElementById("eventMsg");
      if(!name || !date || !city){ msg.textContent="Please provide event name, date, and city."; return; }

      const body = { event_name:name, city, date };
      if (window.currentCoords) { body.lat=window.currentCoords.lat; body.lon=window.currentCoords.lon; }

      try{
        let r, data;
        if (plannerMode === "edit" && editingId){
          r = await fetch(`/events/${editingId}`, {
            method:"PUT",
            headers:{ "Content-Type":"application/json", Authorization:`Bearer ${TOKEN}` },
            body: JSON.stringify(body)
          });
          data = await r.json();
          if(!r.ok) throw new Error(data.error||"Update failed");
          closePlanner();
          await openEventDetails({ id: editingId, event_name:name, city, date });
        } else {
          r = await fetch(`/events`, {
            method:"POST",
            headers:{ "Content-Type":"application/json", Authorization:`Bearer ${TOKEN}` },
            body: JSON.stringify(body)
          });
          data = await r.json();
          if(!r.ok) throw new Error(data.error||"Create failed");
          closePlanner();
          await openEventDetails(data);
        }
        await fetchEvents();
      }catch(e){
        msg.textContent = "Error: " + e.message;
      }
    }

    function wireDatePicker(){
      const dateInput = document.getElementById("eventDate");
      dateInput.addEventListener("change", () => {
        currentDateISO = dateInput.value;
        setDateLabel(currentDateISO);
      });
    }
    function setDateLabel(iso){
      const label = document.getElementById("dateLabel");
      if(!iso){ label.textContent = "No date selected"; return; }
      const d = new Date(iso + "T00:00:00");
      const day = d.getDate().toString().padStart(2,"0");
      const mo  = d.toLocaleString(undefined,{month:"short"});
      const yr  = d.getFullYear();
      label.textContent = `${day} ${mo} ${yr}`;
    }

    // -------------------- Country / City --------------------
    const COUNTRIES = [
      "Singapore","Malaysia","Indonesia","Thailand","Vietnam","Philippines","India","China","Japan","South Korea",
      "Australia","New Zealand","United States","Canada","United Kingdom","Germany","France","Spain","Italy","Netherlands"
    ];
    function populateCountry(selected){
      const sel = document.getElementById("countrySelect");
      sel.innerHTML = "";
      const list = [...COUNTRIES];
      if(selected && !list.includes(selected)) list.unshift(selected);
      list.forEach(c=>{
        const o=document.createElement("option"); o.value=c; o.textContent=c; if(c===selected) o.selected=true; sel.appendChild(o);
      });
    }
    function populateCity(detected){
      const citySel = document.getElementById("citySelect");
      const cityOther = document.getElementById("cityOther");
      citySel.innerHTML = "";
      if(detected){
        const od = document.createElement("option");
        od.value=detected; od.textContent=`${detected}`; citySel.appendChild(od); citySel.value=detected;
      } else {
        const o0=document.createElement("option"); o0.value=""; o0.textContent="Select city‚Ä¶"; o0.disabled=true; o0.selected=true; citySel.appendChild(o0);
      }
      const oOther=document.createElement("option"); oOther.value="__OTHER__"; oOther.textContent="Other city‚Ä¶"; citySel.appendChild(oOther);
      cityOther.classList.add("hidden");
      citySel.onchange = ()=> {
        if(citySel.value==="__OTHER__") cityOther.classList.remove("hidden");
        else { cityOther.classList.add("hidden"); cityOther.value=""; }
      };
    }
    function chosenCity(){
      const sel = document.getElementById("citySelect");
      return sel.value==="__OTHER__" ? document.getElementById("cityOther").value.trim() : sel.value;
    }

    // -------------------- Events --------------------
    async function fetchEvents(){
      const r = await fetch(`/events`, {headers:{Authorization:`Bearer ${TOKEN}`}});
      const data = await r.json();
      const list = document.getElementById("eventsList");
      list.innerHTML = "";
      if(!Array.isArray(data) || data.length===0){
        list.innerHTML = `<div class="muted">No events yet ‚Äî use the <b>Plan</b> button above.</div>`;
        return;
      }
      data.forEach(e=>{
        const row=document.createElement("div"); row.className="item";
        const left=document.createElement("div");
        left.innerHTML=`<div class="item-title">${e.event_name}</div><div class="item-sub">${e.date}${e.city? " ‚Ä¢ "+e.city:""}</div>`;
        const btns=document.createElement("div"); btns.className="btn-row";
        const b1=document.createElement("button"); b1.className="btn btn-primary"; b1.textContent="View"; b1.onclick=()=>openEventDetails(e);
        const b2=document.createElement("button"); b2.className="btn btn-ghost"; b2.textContent="Edit"; b2.onclick=()=>openPlanner('edit', e);
        btns.appendChild(b1); btns.appendChild(b2);
        row.appendChild(left); row.appendChild(btns); list.appendChild(row);
      });
    }

    async function openEventDetails(e){
      document.getElementById("eventTitle").textContent = e.event_name;
      document.getElementById("eventSub").textContent = `${e.date}${e.city ? " ‚Ä¢ " + e.city : ""}`;

      const body = e.id ? {event_id:e.id} : {event_name:e.event_name, date:e.date, lat:e.lat, lon:e.lon};
      const r = await fetch(`/suggest`, {method:"POST", headers:{"Content-Type":"application/json", Authorization:`Bearer ${TOKEN}`}, body:JSON.stringify(body)});
      const data = await r.json();

      document.getElementById("eventHeadline").textContent = `Predicted weather: ${data.predicted || "‚Äî"}`;
      const tips = document.getElementById("eventTips"); tips.innerHTML="";
      (data.advice||[]).forEach(t=>{ const li=document.createElement("li"); li.textContent=t; tips.appendChild(li); });
      document.getElementById("eventNote").textContent = data.note || "";
      showEvent();
    }
  </script>
</body>
</html>
