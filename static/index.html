<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plan4Cast — Event Weather Planner</title>
  <style>
    :root{
      --bg1:#07090e;--bg2:#0f1624;--panel:#121a27;--panel2:#1b2636;
      --teal:#66fcf1;--mint:#45a29e;--muted:#b7c3dc;--stroke:#2d3a4d;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Segoe UI",system-ui,sans-serif;color:#eaf5ff;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));overflow-x:hidden}
    h1{color:var(--teal);margin:.4rem 0 .2rem;text-align:center;letter-spacing:.4px}
    h2{color:var(--mint);margin:.8rem 0 .4rem}
    .muted{color:var(--muted)}
    #app{min-height:100vh;display:flex;flex-direction:column;align-items:center;
      padding:24px 16px 72px;transition:filter .3s ease,opacity .3s ease}
    #app.blurred{filter:blur(8px) brightness(.8)}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);
      backdrop-filter:blur(6px);border-radius:14px;padding:20px;margin:12px 0;
      width:min(95vw,760px);box-shadow:0 8px 30px rgba(0,0,0,.35)}
    .hidden{display:none}
    .btn{padding:.6rem 1rem;border:none;border-radius:10px;cursor:pointer;
      font-weight:600;font-size:.95rem;transition:.2s}
    .btn-primary{background:var(--mint);color:#0b0c10}
    .btn-primary:hover{background:var(--teal)}
    .btn-ghost{background:#223043;color:#e6f7f6;border:1px solid var(--stroke)}
    .btn-ghost:hover{background:#2a3b53}
    .header{display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:10px}
    .time{font-size:1.25rem;font-weight:700}
    .loc{font-size:.95rem;color:var(--muted)}
    .wx{font-size:.95rem;opacity:.9}
    .list{margin-top:.5rem}
    .item{display:grid;grid-template-columns:1fr auto;align-items:center;
      padding:.6rem .3rem;border-bottom:1px solid rgba(255,255,255,.06)}
    .item-title{font-weight:700;letter-spacing:.2px;text-transform:capitalize}
    .item-sub{color:var(--muted);font-size:.9rem}
    .btn-row{display:flex;gap:.4rem}
    #footer{position:fixed;bottom:0;left:0;right:0;text-align:center;
      padding:.55rem;border-top:1px solid rgba(255,255,255,.08);
      background:rgba(18,27,41,.92);font-size:.85rem;color:var(--muted)}
    /* Modal/Loader */
    #loader{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      backdrop-filter:blur(8px) brightness(.8);background:rgba(0,0,0,.4);z-index:9999}
    .spinner{width:56px;height:56px;border:6px solid #66fcf1;border-top-color:transparent;
      border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Welcome overlay */
    #welcome{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.9);color:#fff;font-size:1.6rem;z-index:2000;opacity:1;
      transition:opacity 1.2s ease}
    #welcome.fade{opacity:0}
    /* Assistant panel */
    .assistant{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
      border-radius:16px;padding:16px;display:flex;gap:12px;align-items:flex-start;
      box-shadow:0 0 15px rgba(102,252,241,.15);margin-top:.5rem}
    .assistant-icon{width:38px;height:38px;border-radius:50%;background:var(--teal);
      display:flex;align-items:center;justify-content:center;font-weight:700;color:#0b0c10}
    .assistant-body{flex:1}
  </style>
</head>
<body>
<div id="app">
  <h1>Plan4Cast</h1>
  <p class="muted" style="text-align:center;margin-top:-6px;">
    Powered by NASA POWER Dataset & Meteomatics API
  </p>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h2>Login</h2>
    <input id="loginUsername" placeholder="Username"/><br>
    <input id="loginPin" placeholder="4-digit PIN" maxlength="4" inputmode="numeric" type="password"/><br>
    <button class="btn btn-primary" onclick="login()">Login</button>
    <p id="loginMsg"></p>
    <p class="muted">No account? <a href="#" onclick="showSignup()" style="color:var(--teal)">Sign up</a></p>
  </div>

  <!-- SIGNUP -->
  <div id="signupCard" class="card hidden">
    <h2>Sign Up</h2>
    <input id="signupUsername" placeholder="Username"/><br>
    <input id="signupPin" placeholder="4-digit PIN" maxlength="4" inputmode="numeric" type="password"/><br>
    <button class="btn btn-primary" onclick="signup()">Create Account</button>
    <p id="signupMsg"></p>
    <p class="muted">Have an account? <a href="#" onclick="showLogin()" style="color:var(--teal)">Login</a></p>
  </div>

  <!-- HOME -->
  <div id="homeCard" class="card hidden">
    <div class="header">
      <div>
        <div class="time" id="clock">--:--</div>
        <div class="loc" id="locLine"></div>
      </div>
      <div class="wx" id="wxNow"></div>
      <button class="btn btn-primary" onclick="openPlanner('create')">Plan</button>
    </div>
    <h2 style="margin-top:1rem;">Upcoming Events</h2>
    <div id="eventsList" class="list"></div>
    <div style="margin-top:12px;text-align:right">
      <button class="btn btn-ghost" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- EVENT -->
  <div id="eventCard" class="card hidden">
    <button class="btn btn-ghost" style="float:right" onclick="showHome()">← Back</button>
    <h2 id="eventTitle">Event</h2>
    <p id="eventSub" class="muted"></p>
    <div id="assistantBox" class="assistant">
      <div class="assistant-icon">A</div>
      <div class="assistant-body">
        <p id="eventHeadline" style="margin:.3rem 0 .4rem;font-weight:600"></p>
        <ul id="eventTips"></ul>
        <p id="eventNote" class="muted"></p>
      </div>
    </div>
  </div>

  <!-- Planner modal -->
  <div id="planner" class="card hidden" style="position:fixed;top:10%;z-index:1000;">
    <h2 id="plannerTitle">Plan New Event</h2>
    <input id="eventName" placeholder="Event name"/><br>
    <label>Date</label>
    <input id="eventDate" type="date"/><br>
    <label>Country</label>
    <select id="countrySelect"></select><br>
    <label>City</label>
    <select id="citySelect"></select>
    <input id="cityOther" class="hidden" placeholder="Other city"/><br>
    <div style="text-align:right">
      <button class="btn btn-ghost" onclick="closePlanner()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEvent()">Save</button>
    </div>
    <p id="eventMsg"></p>
  </div>
</div>

<!-- Loader + Welcome + Footer -->
<div id="loader"><div class="spinner"></div></div>
<div id="welcome"><span id="welcomeMsg"></span></div>
<div id="footer">Temasek Polytechnic Team 1 (AEL/AEG/BME) + SP EEE</div>

<script>
const API="";let TOKEN=localStorage.getItem("token")||null;let plannerMode="create",editingId=null;
function hideAll(){document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"))}
function showLogin(){hideAll();loginCard.classList.remove("hidden")}
function showSignup(){hideAll();signupCard.classList.remove("hidden")}
function showHome(){hideAll();homeCard.classList.remove("hidden");fetchEvents()}
function showEvent(){hideAll();eventCard.classList.remove("hidden")}
function showLoader(b){document.getElementById("loader").style.display=b?"flex":"none"}
function titleCase(s){return s.replace(/\w\S*/g,t=>t[0].toUpperCase()+t.substr(1).toLowerCase())}

window.addEventListener("load",()=>{
  tickClock();setInterval(tickClock,1000);
  if(TOKEN)showWelcome();else showLogin();
  loadCountries();
});
function tickClock(){const n=new Date();
  clock.textContent=`${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}`;}

async function signup(){
  const username=signupUsername.value.trim().toLowerCase(),pin=signupPin.value.trim();
  const r=await fetch(`/signup`,{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username,pin})});const d=await r.json();
  if(d.ok){TOKEN=d.token;localStorage.setItem("token",TOKEN);showWelcome();}
  else signupMsg.textContent=d.error||"Signup failed";
}
async function login(){
  const username=loginUsername.value.trim().toLowerCase(),pin=loginPin.value.trim();
  const r=await fetch(`/login`,{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username,pin})});const d=await r.json();
  if(d.ok){TOKEN=d.token;localStorage.setItem("token",TOKEN);showWelcome();}
  else loginMsg.textContent=d.error||"Login failed";
}
function logout(){TOKEN=null;localStorage.removeItem("token");showLogin()}

function showWelcome(){
  welcomeMsg.textContent=`Welcome, ${localStorage.getItem("lastUser")||"User"}!`;
  welcome.style.display="flex";app.classList.add("blurred");
  setTimeout(()=>welcome.classList.add("fade"),1000);
  setTimeout(()=>{welcome.style.display="none";app.classList.remove("blurred");showHome();},2200);
}

async function fetchEvents(){
  showLoader(true);
  const r=await fetch(`/events`,{headers:{Authorization:`Bearer ${TOKEN}`}});
  const data=await r.json();const list=eventsList;list.innerHTML="";
  if(!Array.isArray(data)||!data.length){list.innerHTML="<div class='muted'>No events yet.</div>";showLoader(false);return;}
  data.forEach(e=>{
    const row=document.createElement("div");row.className="item";
    const left=document.createElement("div");
    left.innerHTML=`<div class='item-title'>${titleCase(e.event_name)}</div><div class='item-sub'>${e.date}${e.city?" • "+e.city:""}</div>`;
    const btns=document.createElement("div");btns.className="btn-row";
    const v=document.createElement("button");v.className="btn btn-primary";v.textContent="View";
    v.onclick=()=>openEventDetails(e);
    const ed=document.createElement("button");ed.className="btn btn-ghost";ed.textContent="Edit";
    ed.onclick=()=>openPlanner('edit',e);
    btns.appendChild(v);btns.appendChild(ed);row.appendChild(left);row.appendChild(btns);list.appendChild(row);
  });
  showLoader(false);
}

async function openEventDetails(e){
  showLoader(true);
  eventTitle.textContent=titleCase(e.event_name);
  eventSub.textContent=`${e.date}${e.city?" • "+e.city:""}`;
  const body=e.id?{event_id:e.id}:{event_name:e.event_name,date:e.date,lat:e.lat,lon:e.lon};
  const r=await fetch(`/suggest`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${TOKEN}`},body:JSON.stringify(body)});
  const d=await r.json();
  eventHeadline.textContent=`Predicted Weather: ${d.predicted||"—"}`;
  eventTips.innerHTML="";
  (d.advice||[]).forEach(t=>{const li=document.createElement("li");li.textContent=t;eventTips.appendChild(li)});
  eventNote.textContent=`Recommendation Notes: ${d.note||""}`;
  showLoader(false);showEvent();
}

/* Planner */
async function openPlanner(mode="create",ev=null){
  plannerMode=mode;editingId=ev?.id||null;plannerTitle.textContent=mode==="edit"?"Edit Event":"Plan New Event";
  eventMsg.textContent="";eventName.value=ev?.event_name||"";eventDate.value=ev?.date||"";
  countrySelect.value="";citySelect.innerHTML="";cityOther.value="";
  planner.classList.remove("hidden");await loadCountries(ev?.country||"");if(ev?.country_code)await loadCities(ev.country_code,ev.city);
}
function closePlanner(){planner.classList.add("hidden")}
async function saveEvent(){
  const name=eventName.value.trim(),date=eventDate.value,cc=countrySelect.value;
  let city=citySelect.value==="__OTHER__"?cityOther.value.trim():citySelect.value;
  if(!name||!date||!cc){eventMsg.textContent="Please fill all fields.";return;}
  const country=countrySelect.options[countrySelect.selectedIndex].text;
  const body={event_name:name,date,city,country};
  if(window.currentCoords){body.lat=currentCoords.lat;body.lon=currentCoords.lon;}
  showLoader(true);
  const r=await fetch(plannerMode==="edit"?`/events/${editingId}`:"/events",{method:plannerMode==="edit"?"PUT":"POST",
    headers:{"Content-Type":"application/json",Authorization:`Bearer ${TOKEN}`},body:JSON.stringify(body)});
  const d=await r.json();
  showLoader(false);
  if(!r.ok){eventMsg.textContent=d.error||"Save failed";return;}
  closePlanner();fetchEvents();openEventDetails(d);
}

/* Country/City */
async function loadCountries(sel=""){
  const r=await fetch("/geo/countries");const d=await r.json();countrySelect.innerHTML="";
  d.forEach(c=>{const o=document.createElement("option");o.value=c.code;o.textContent=c.name;if(c.name===sel)o.selected=true;countrySelect.appendChild(o)});
  countrySelect.onchange=()=>loadCities(countrySelect.value);
}
async function loadCities(code,prefer=""){
  showLoader(true);
  const r=await fetch(`/geo/cities?code=${encodeURIComponent(code)}`);const d=await r.json();
  citySelect.innerHTML="";const list=d.cities||[];
  if(d.cityless){const o=document.createElement("option");o.textContent=list[0];o.value=list[0];citySelect.appendChild(o);citySelect.disabled=true;}
  else{citySelect.disabled=false;list.forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;citySelect.appendChild(o)});
    const oOther=document.createElement("option");oOther.value="__OTHER__";oOther.textContent="Other city…";citySelect.appendChild(oOther);
    citySelect.onchange=()=>{if(citySelect.value==="__OTHER__")cityOther.classList.remove("hidden");else cityOther.classList.add("hidden")};}
  showLoader(false);
}

/* Geolocation for weather header */
navigator.geolocation.getCurrentPosition(async pos => {
  window.currentCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
  try {
    // Update current weather from backend
    const cw = await fetch(`/current_weather?lat=${currentCoords.lat}&lon=${currentCoords.lon}`);
    const data = await cw.json();
    if (data && data.temp !== undefined) {
      wxNow.textContent = `${data.desc} • ${data.temp.toFixed(1)}°C`;
    } else {
      wxNow.textContent = "";
    }

    // Reverse geocode to display user's location
    const rev = await fetch(`/reverse_geocode?lat=${currentCoords.lat}&lon=${currentCoords.lon}`);
    const loc = await rev.json();
    if (loc.city || loc.country) {
      locLine.textContent = [loc.city, loc.country].filter(Boolean).join(", ");
    } else {
      locLine.textContent = "";
    }

    // Prefill the planner form with detected country
    if (loc.country_code) {
      const csel = document.getElementById("countrySelect");
      [...csel.options].forEach(o => {
        if (o.value === loc.country_code) o.selected = true;
      });
    }
  } catch (e) {
    console.warn("Geo/weather fetch error:", e);
  }
}, err => {
  console.warn("Geolocation denied or unavailable:", err);
  wxNow.textContent = "";
  locLine.textContent = "";
});

/* ------------------------------------
   END: Script
------------------------------------ */
</script>
</body>
</html>
