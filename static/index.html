<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plan4Cast — Event Weather Planner</title>
  <style>
    :root{
      --bg1:#07090e;--bg2:#0f1624;--panel:#121a27;--panel2:#1b2636;
      --teal:#66fcf1;--mint:#45a29e;--muted:#b7c3dc;--stroke:#2d3a4d;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Segoe UI",system-ui,Arial,sans-serif;color:#eaf5ff;
      background:radial-gradient(900px 500px at 10% -10%, #0a1930 0%, transparent 60%),
                 radial-gradient(800px 400px at 90% 110%, #08212f 0%, transparent 55%),
                 linear-gradient(180deg,var(--bg1),var(--bg2));}
    h1{color:var(--teal);margin:.25rem 0 .25rem;text-align:center;letter-spacing:.4px}
    h2{color:var(--mint);margin:.8rem 0 .5rem}
    .muted{color:var(--muted)}
    #app{min-height:100vh;display:flex;flex-direction:column;align-items:center;
      padding:24px 16px 84px;transition:filter .25s ease,opacity .25s ease}
    #app.blurred{filter:blur(9px) brightness(.8)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06);backdrop-filter: blur(6px);
      width:min(95vw,760px);border-radius:14px;padding:18px 20px;margin:12px 0;
      box-shadow:0 12px 36px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02)}
    .hidden{display:none}
    .btn{padding:.62rem 1rem;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:.95rem;transition:.2s}
    .btn-primary{background:var(--mint);color:#0b0c10}
    .btn-primary:hover{background:var(--teal)}
    .btn-ghost{background:#223043;color:#e6f7f6;border:1px solid var(--stroke)}
    .btn-ghost:hover{background:#2a3b53}
    .header{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
    .time{font-size:1.25rem;font-weight:700}
    .loc{font-size:.95rem;color:var(--muted);min-height:1.25rem}
    .wx{font-size:.95rem;opacity:.9;min-height:1.25rem}
    .list{margin-top:.5rem}
    .item{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center;padding:.7rem .35rem;border-bottom:1px solid rgba(255,255,255,.06)}
    .item-title{font-weight:700;letter-spacing:.2px;text-transform:capitalize}
    .item-sub{color:var(--muted);font-size:.92rem}
    .btn-row{display:flex;gap:.45rem}
    #footer{position:fixed;bottom:0;left:0;right:0;text-align:center;padding:.6rem;border-top:1px solid rgba(255,255,255,.08);
      background:rgba(18,27,41,.92);font-size:.9rem;color:var(--muted)}
    /* Loader */
    #loader{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;
      background:rgba(0,0,0,.35);backdrop-filter:blur(9px) brightness(.8)}
    .spinner{width:58px;height:58px;border:6px solid #66fcf1;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Welcome overlay */
    #welcome{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:2000;background:rgba(0,0,0,.92);color:#fff}
    #welcomeText{font-size:1.7rem;opacity:1;transition:opacity 1.2s ease}
    #welcome.fade #welcomeText{opacity:0}
    /* Assistant panel */
    .assistant{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;display:flex;gap:12px;align-items:flex-start;box-shadow:0 0 22px rgba(102,252,241,.15);margin-top:.5rem}
    .assistant-icon{width:38px;height:38px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;font-weight:800;color:#0b0c10}
    .assistant-body{flex:1}
    /* Planner modal look (kept as card but floats) */
    #planner{position:fixed;top:8%;left:50%;transform:translateX(-50%);z-index:1500}
    input,select{width:100%;padding:.65rem .75rem;border:1px solid var(--stroke);border-radius:10px;background:#0f1928;color:#fff;font-size:1rem;outline:none;box-shadow:0 3px 0 rgba(0,0,0,.25) inset}
    label{font-size:.92rem;color:var(--muted);display:block;margin:.35rem 0 .3rem}
  </style>
</head>
<body>
  <div id="app">
    <h1>Plan4Cast</h1>
    <p class="muted" style="text-align:center;margin-top:-6px;">
      Powered by NASA POWER Dataset & Meteomatics API
    </p>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h2>Login</h2>
      <div class="row">
        <input id="loginUsername" placeholder="Username" autocomplete="off"/>
        <input id="loginPin" placeholder="4-digit PIN" maxlength="4" inputmode="numeric" type="password"/>
        <button class="btn btn-primary" onclick="login()">Login</button>
        <p id="loginMsg"></p>
        <p class="muted">Don’t have an account? <a href="#" onclick="showSignup()" style="color:var(--teal);text-decoration:none">Sign up</a></p>
      </div>
    </div>

    <!-- SIGNUP -->
    <div id="signupCard" class="card hidden">
      <h2>Sign Up</h2>
      <div class="row">
        <input id="signupUsername" placeholder="Choose username" autocomplete="off"/>
        <input id="signupPin" placeholder="4-digit PIN" maxlength="4" inputmode="numeric" type="password"/>
        <button class="btn btn-primary" onclick="signup()">Create Account</button>
        <p id="signupMsg"></p>
        <p class="muted">Already have an account? <a href="#" onclick="showLogin()" style="color:var(--teal);text-decoration:none">Login</a></p>
      </div>
    </div>

    <!-- HOME -->
    <div id="homeCard" class="card hidden">
      <div class="header">
        <div>
          <div class="time" id="clock">--:--</div>
          <div class="loc" id="locLine"></div>
        </div>
        <div class="wx" id="wxNow"></div>
        <button class="btn btn-primary" onclick="openPlanner('create')">Plan</button>
      </div>

      <h2 style="margin-top:1rem;">Upcoming Events</h2>
      <div id="eventsList" class="list"></div>

      <div style="margin-top:12px;display:flex;justify-content:flex-end;">
        <button class="btn btn-ghost" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- EVENT DETAILS -->
    <div id="eventCard" class="card hidden">
      <button onclick="showHome()" class="btn btn-ghost" style="float:right;">← Back</button>
      <h2 id="eventTitle">Event</h2>
      <p id="eventSub" class="muted">Date & Location</p>
      <div id="assistantBox" class="assistant">
        <div class="assistant-icon">A</div>
        <div class="assistant-body">
          <p id="eventHeadline" style="margin:.2rem 0 .5rem;font-weight:700"></p>
          <ul id="eventTips"></ul>
          <p class="muted" id="eventNote"></p>
        </div>
      </div>
    </div>

    <!-- Planner -->
    <div id="planner" class="card hidden">
      <h2 id="plannerTitle">Plan New Event</h2>
      <label>Event name</label>
      <input id="eventName"/>
      <label>Date</label>
      <input id="eventDate" type="date"/>
      <label>Country</label>
      <select id="countrySelect"></select>
      <label>City</label>
      <select id="citySelect"></select>
      <input id="cityOther" class="hidden" placeholder="Other city"/>
      <div style="display:flex;gap:.6rem;justify-content:flex-end;margin-top:.6rem;">
        <button class="btn btn-ghost" onclick="closePlanner()">Cancel</button>
        <button id="saveBtn" class="btn btn-primary" onclick="saveEvent()">Save</button>
      </div>
      <p id="eventMsg"></p>
    </div>
  </div>

  <!-- Loader + Welcome + Footer -->
  <div id="loader"><div class="spinner"></div></div>
  <div id="welcome"><div id="welcomeText">Welcome!</div></div>
  <div id="footer">Temasek Polytechnic Team 1 (AEL/AEG/BME) + SP EEE</div>

<script>
const API_BASE="";let TOKEN=localStorage.getItem("token")||null;
let plannerMode="create", editingId=null;

function hideAll(){document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"))}
function showLogin(){hideAll();loginCard.classList.remove("hidden")}
function showSignup(){hideAll();signupCard.classList.remove("hidden")}
function showHome(){hideAll();homeCard.classList.remove("hidden");fetchEvents()}
function showEvent(){hideAll();eventCard.classList.remove("hidden")}
function showLoader(v){document.getElementById("loader").style.display=v?"flex":"none"}
function titleCase(s){return (s||"").replace(/\w\S*/g,t=>t[0].toUpperCase()+t.slice(1).toLowerCase())}

window.addEventListener("load",()=>{
  tickClock();setInterval(tickClock,1000);
  if(TOKEN){welcomeSequence();} else {showLogin();}
  loadCountries();
});

function tickClock(){const now=new Date();
  clock.textContent=`${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;}

async function signup(){
  const username=signupUsername.value.trim().toLowerCase();
  const pin=signupPin.value.trim();
  const r=await fetch(`${API_BASE}/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,pin})});
  const data=await r.json();
  if(data.ok){TOKEN=data.token;localStorage.setItem("token",TOKEN);localStorage.setItem("lastUser",username);welcomeSequence();}
  else signupMsg.textContent=data.error||"Signup failed";
}

async function login(){
  const username=loginUsername.value.trim().toLowerCase();
  const pin=loginPin.value.trim();
  const r=await fetch(`${API_BASE}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,pin})});
  const data=await r.json();
  if(data.ok){TOKEN=data.token;localStorage.setItem("token",TOKEN);localStorage.setItem("lastUser",username);welcomeSequence();}
  else loginMsg.textContent=data.error||"Login failed";
}

function logout(){TOKEN=null;localStorage.removeItem("token");showLogin();}

function welcomeSequence(){
  const u=localStorage.getItem("lastUser")||"User";
  welcomeText.textContent=`Welcome, ${u}!`;
  document.getElementById("welcome").style.display="flex";
  document.getElementById("app").classList.add("blurred");
  setTimeout(()=>document.getElementById("welcome").classList.add("fade"),1100);
  setTimeout(()=>{
    document.getElementById("welcome").style.display="none";
    document.getElementById("app").classList.remove("blurred");
    showHome();
    initGeoHeader();
  },2300);
}

/* ---------------- Home: Events ---------------- */
async function fetchEvents(){
  showLoader(true);
  try{
    const r=await fetch(`/events`,{headers:{Authorization:`Bearer ${TOKEN}`}});
    const data=await r.json();
    const list=document.getElementById("eventsList");
    list.innerHTML="";
    if(!Array.isArray(data)||!data.length){
      list.innerHTML=`<div class="muted">No events yet — tap <b>Plan</b> to add one.</div>`;
    }else{
      data.forEach(e=>{
        const row=document.createElement("div");row.className="item";
        const left=document.createElement("div");
        left.innerHTML=`<div class="item-title">${titleCase(e.event_name)}</div><div class="item-sub">${e.date}${e.city?" • "+e.city:""}</div>`;
        const btns=document.createElement("div");btns.className="btn-row";
        const b1=document.createElement("button");b1.className="btn btn-primary";b1.textContent="View";b1.onclick=()=>openEventDetails(e);
        const b2=document.createElement("button");b2.className="btn btn-ghost";b2.textContent="Edit";b2.onclick=()=>openPlanner('edit',e);
        btns.appendChild(b1);btns.appendChild(b2);
        row.appendChild(left);row.appendChild(btns);list.appendChild(row);
      });
    }
  }catch(e){
    console.error(e);
  }finally{showLoader(false);}
}

async function openEventDetails(e){
  showLoader(true);
  try{
    document.getElementById("eventTitle").textContent=titleCase(e.event_name);
    document.getElementById("eventSub").textContent=`${e.date}${e.city?" • "+e.city:""}`;

    const body=e.id?{event_id:e.id}:{event_name:e.event_name,date:e.date,lat:e.lat,lon:e.lon};
    const r=await fetch(`/suggest`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${TOKEN}`},body:JSON.stringify(body)});
    const d=await r.json();

    document.getElementById("eventHeadline").textContent=`Predicted Weather: ${d.predicted||"—"}`;
    const tipsUl=document.getElementById("eventTips"); tipsUl.innerHTML="";
    (d.advice||[]).forEach(t=>{const li=document.createElement("li");li.textContent=t;tipsUl.appendChild(li);});
    document.getElementById("eventNote").textContent = d.note ? `Recommendation Notes: ${d.note}` : "Recommendation Notes: —";
    showEvent();
  }catch(err){
    alert("Unable to load suggestions.");
  }finally{showLoader(false);}
}

/* ---------------- Planner ---------------- */
function openPlanner(mode="create",ev=null){
  plannerMode=mode; editingId=ev?.id||null;
  plannerTitle.textContent = mode==="edit" ? "Edit Event" : "Plan New Event";
  eventMsg.textContent=""; eventName.value = ev?.event_name || "";
  eventDate.value = ev?.date || "";
  planner.classList.remove("hidden");
  // Ensure countries loaded, then preselect if possible:
  loadCountries(ev?.country || "", ev?.city || "");
}
function closePlanner(){planner.classList.add("hidden")}

async function saveEvent(){
  const name=eventName.value.trim();
  const date=eventDate.value.trim();
  const countryCode=countrySelect.value;
  const countryName=countrySelect.options[countrySelect.selectedIndex]?.text || "";
  let city="";
  if(citySelect.value==="__OTHER__") city = (cityOther.value||"").trim();
  else city = citySelect.value;

  if(!name||!date||!countryCode){ eventMsg.textContent="Please provide event name, date and country."; return; }

  const body={event_name:name,date,city:city||null,country:countryName||null};
  if(window.currentCoords){ body.lat=currentCoords.lat; body.lon=currentCoords.lon; }

  showLoader(true);
  try{
    const r=await fetch(plannerMode==="edit"?`/events/${editingId}`:`/events`,{
      method: plannerMode==="edit"?"PUT":"POST",
      headers:{"Content-Type":"application/json", Authorization:`Bearer ${TOKEN}`},
      body:JSON.stringify(body)
    });
    const d=await r.json();
    if(!r.ok) throw new Error(d.error||"Save failed");
    closePlanner(); await fetchEvents(); await openEventDetails(d);
  }catch(e){
    eventMsg.textContent="Error: "+e.message;
  }finally{ showLoader(false); }
}

/* ---------------- Country / City ---------------- */
async function loadCountries(preferName="", preferCity=""){
  try{
    const r=await fetch("/geo/countries"); const data=await r.json();
    const sel=countrySelect; sel.innerHTML="";
    data.forEach(c=>{
      const o=document.createElement("option");
      o.value=c.code; o.textContent=c.name;
      if(preferName && c.name===preferName) o.selected=true;
      sel.appendChild(o);
    });
    sel.onchange=()=>loadCities(sel.value);
    // If we already know user location, preselect by code
    if(window._detectedCountryCode){
      [...sel.options].forEach(o=>{ if(o.value===window._detectedCountryCode) o.selected=true; });
    }
    // Load cities for selected
    loadCities(sel.value, preferCity);
  }catch(e){
    console.error("countries failed", e);
  }
}

async function loadCities(code, preferCity=""){
  const citySel=document.getElementById("citySelect");
  const cityOther=document.getElementById("cityOther");
  citySel.innerHTML=""; cityOther.classList.add("hidden"); cityOther.value="";

  if(code==="SG"){
    const o=document.createElement("option"); o.value="Singapore"; o.textContent="Singapore"; o.selected=true;
    citySel.appendChild(o); citySel.disabled=true; return;
  }else{ citySel.disabled=false; }

  showLoader(true);
  try{
    const r=await fetch(`/geo/cities?code=${encodeURIComponent(code)}`);
    const jd=await r.json();
    const cities=Array.isArray(jd.cities)?jd.cities:[];
    if(!cities.length){
      const o=document.createElement("option"); o.value=""; o.textContent="Select city…"; o.disabled=true; o.selected=true;
      citySel.appendChild(o);
    }else{
      const opt0=document.createElement("option"); opt0.value=""; opt0.textContent="Select city…"; opt0.disabled=true; opt0.selected=true; citySel.appendChild(opt0);
      cities.forEach(n=>{const o=document.createElement("option");o.value=n;o.textContent=n;citySel.appendChild(o);});
    }
    const optOther=document.createElement("option"); optOther.value="__OTHER__"; optOther.textContent="Other city…"; citySel.appendChild(optOther);
    if(preferCity && cities.includes(preferCity)) citySel.value=preferCity;

    citySel.onchange=()=>{ if(citySel.value==="__OTHER__") cityOther.classList.remove("hidden"); else { cityOther.classList.add("hidden"); cityOther.value=""; } };
  }catch(e){
    console.error("cities failed", e);
    const o=document.createElement("option"); o.value=""; o.textContent="(No cities)"; o.disabled=true; o.selected=true; citySel.appendChild(o);
  }finally{ showLoader(false); }
}

/* ---------------- Geolocation for header + prefill ---------------- */
function initGeoHeader(){
  if(!navigator.geolocation){ wxNow.textContent=""; locLine.textContent=""; return; }
  navigator.geolocation.getCurrentPosition(async pos=>{
    window.currentCoords={lat:pos.coords.latitude, lon:pos.coords.longitude};
    try{
      // Weather now
      const cw=await fetch(`/current_weather?lat=${currentCoords.lat}&lon=${currentCoords.lon}`);
      const data=await cw.json();
      wxNow.textContent = (data && data.temp !== undefined) ? `${data.desc} • ${Number(data.temp).toFixed(1)}°C` : "";

      // Reverse geocode
      const rv=await fetch(`/reverse_geocode?lat=${currentCoords.lat}&lon=${currentCoords.lon}`);
      const loc=await rv.json();
      if(loc.city||loc.country) locLine.textContent=[loc.city,loc.country].filter(Boolean).join(", ");
      else locLine.textContent="";

      // Preselect country
      if(loc.country_code){
        window._detectedCountryCode=loc.country_code;
        const sel=document.getElementById("countrySelect");
        if(sel && sel.options.length){
          [...sel.options].forEach(o=>{ if(o.value===loc.country_code) o.selected=true; });
          loadCities(loc.country_code, loc.city||"");
        }
      }
    }catch(e){
      wxNow.textContent=""; locLine.textContent="";
    }
  }, err=>{
    wxNow.textContent=""; locLine.textContent="";
  }, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
}
</script>
</body>
</html>
