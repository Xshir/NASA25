<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plan4Cast</title>
  <style>
    :root{--bg:#0b1220;--panel:#131c2b;--ink:#eaf2ff;--muted:#9bb0d1;--teal:#63f5e5}
    *{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#0b1220,#0e1728);color:var(--ink);font-family:ui-sans-serif,system-ui,Segoe UI,Arial}
    h1{font-size:20px;margin:0 0 8px} .wrap{max-width:980px;margin:24px auto;padding:16px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr} .card{background:var(--panel);border:1px solid #233149;border-radius:16px;padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button{width:100%;padding:10px 12px;border:1px solid #2a3a52;background:#0f1828;color:var(--ink);border-radius:12px;outline:none}
    button{cursor:pointer;background:#1a2840}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#11213a;border:1px solid #24344c;margin:4px 6px 0 0}
    .out{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Plan4Cast</h1>
  <div class="grid">
    <div class="card">
      <div class="row">
        <div>
          <label>Username</label>
          <input id="u" placeholder="e.g. haashir" />
        </div>
        <div>
          <label>PIN (4 digits)</label>
          <input id="p" placeholder="1234" maxlength="4" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button onclick="doSignup()">Sign up</button>
        <button onclick="doLogin()">Log in</button>
      </div>
      <div class="hint" id="authHint"></div>
    </div>

    <div class="card">
      <label>Event name</label>
      <input id="eventName" placeholder="e.g. Drone flying at East Coast" />
      <div class="row" style="margin-top:8px">
        <div><label>Date (YYYY-MM-DD)</label><input id="date" placeholder="2025-10-06" /></div>
        <div><label>Country</label><select id="country"></select></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>City</label><select id="citySel"></select></div>
        <div><label>Or type a city</label><input id="cityFree" placeholder="Any city name worldwide" /></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Latitude</label><input id="lat" placeholder="auto from city" /></div>
        <div><label>Longitude</label><input id="lon" placeholder="auto from city" /></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button onclick="suggest()">Get recommendation</button>
        <button onclick="saveEvent()">Save event</button>
      </div>
      <div class="hint">Tip: choose a city from the list or type any city; coordinates will auto-fill. Works for every country.</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div id="output" class="out"></div>
    <div id="advice"></div>
  </div>
</div>

<script>
let token = localStorage.getItem('pf_token') || ''
const $ = (id) => document.getElementById(id)

async function doSignup(){
  const r = await fetch('/signup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:$.u.value,pin:$.p.value})})
  const js = await r.json(); if(js.token){ token=js.token; localStorage.setItem('pf_token',token); $.authHint.textContent='Signed up & logged in.' } else { $.authHint.textContent=js.error||'Error' }
}
async function doLogin(){
  const r = await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:$.u.value,pin:$.p.value})})
  const js = await r.json(); if(js.token){ token=js.token; localStorage.setItem('pf_token',token); $.authHint.textContent='Logged in.' } else { $.authHint.textContent=js.error||'Error' }
}

async function loadCountries(){
  const r = await fetch('/geo/countries'); const list = await r.json()
  $.country.innerHTML = '<option value="">Select country</option>' + list.map(it=>`<option value="${it.code}">${it.name}</option>`).join('')
}
async function loadCities(){
  const code = $.country.value
  if(!code){ $.citySel.innerHTML = '<option value="">Select city</option>'; return }
  const r = await fetch('/geo/cities?code='+encodeURIComponent(code))
  const js = await r.json()
  if(js.cityless){
    $.citySel.innerHTML = '<option value="__centroid">Singapore (city-state)</option>'
    $.lat.value = js.centroid?.lat ?? ''
    $.lon.value = js.centroid?.lon ?? ''
    return
  }
  const cities = js.cities || []
  $.citySel.innerHTML = '<option value="">Select city</option>' + cities.map(c=>`<option value="${c.lat},${c.lon}">${c.name}</option>`).join('')
}

$.country.addEventListener('change', loadCities)
$.citySel.addEventListener('change', ()=>{
  const v = $.citySel.value
  if(v && v!=='__centroid'){
    const [lt,ln] = v.split(','); $.lat.value = lt; $.lon.value = ln
  }
})

async function geocodeFreeCity(){
  const q = $.cityFree.value.trim()
  if(!q) return
  const res = await fetch('https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q='+encodeURIComponent(q),{headers:{'Accept':'application/json','User-Agent':'Plan4Cast/1.0'}})
  const arr = await res.json()
  if(arr && arr[0]){ $.lat.value = arr[0].lat; $.lon.value = arr[0].lon }
}
$.cityFree.addEventListener('blur', geocodeFreeCity)

function show(js){
  $.output.textContent = JSON.stringify(js, null, 2)
  $.advice.innerHTML = (js.advice||[]).map(t=>`<span class="pill">${t}</span>`).join('')
}

async function suggest(){
  if(!token){ $.authHint.textContent='Please log in first.'; return }
  if(!$.lat.value || !$.lon.value){
    await geocodeFreeCity()
  }
  const body = {
    event_name: $.eventName.value,
    date: $.date.value,
    lat: $.lat.value?parseFloat($.lat.value):null,
    lon: $.lon.value?parseFloat($.lon.value):null
  }
  const r = await fetch('/suggest',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(body)})
  const js = await r.json(); show(js)
}

async function saveEvent(){
  if(!token){ $.authHint.textContent='Please log in first.'; return }
  const body = {
    event_name: $.eventName.value,
    date: $.date.value,
    city: $.cityFree.value || ($.citySel.options[$.citySel.selectedIndex]?.text || ''),
    country: $.country.options[$.country.selectedIndex]?.text || '',
    lat: $.lat.value?parseFloat($.lat.value):null,
    lon: $.lon.value?parseFloat($.lon.value):null
  }
  const r = await fetch('/events',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(body)})
  const js = await r.json(); show(js)
}

loadCountries()
</script>
</body>
</html>
