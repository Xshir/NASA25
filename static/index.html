<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plan4Cast — Event Weather Planner</title>
  <style>
    :root{
      --bg1:#07090e; --bg2:#0f1624;
      --panel:#121a27; --panel-2:#1b2636;
      --teal:#66fcf1; --mint:#45a29e;
      --muted:#b7c3dc; --stroke:#2d3a4d; --accent:#2b3442;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
      margin:0; color:#eaf5ff;
      background:
        radial-gradient(1200px 600px at 10% -10%, #0a1930 0%, transparent 60%),
        radial-gradient(1000px 500px at 90% 110%, #08212f 0%, transparent 55%),
        linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 100%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    #app{
      min-height:100dvh;
      display:flex; flex-direction:column; align-items:center;
      padding:24px 16px 72px;
      transition:filter .25s ease, opacity .25s ease;
    }
    #app.blurred{ filter:blur(12px) saturate(85%) brightness(.85); }

    h1{color:var(--teal); margin:.2rem 0 .3rem; letter-spacing:.4px}
    h2{color:var(--mint); margin:1rem 0 .6rem}
    .muted{color:var(--muted)}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(6px);
      width:min(95vw,760px);
      border-radius:14px; padding:18px 20px; margin:12px 0;
      box-shadow:0 12px 36px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02);
      transition:transform .05s ease;
    }
    .card:active{transform:translateY(1px)}
    .hidden{display:none}

    .header{
      display:grid; grid-template-columns:1fr auto auto; gap:12px; align-items:center;
      padding:12px 14px; border-radius:14px; background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .time{font-size:1.25rem; font-weight:700}
    .loc{font-size:.95rem; color:var(--muted)}
    .wx{font-size:.95rem; opacity:.9}

    .btn{
      padding:.55rem .9rem; border:none; border-radius:10px; cursor:pointer; font-weight:700; font-size:.95rem;
      transition:transform .05s ease, background .2s ease, box-shadow .2s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--mint); color:#0b0c10;}
    .btn-primary:hover{background:var(--teal); box-shadow:0 10px 24px rgba(102,252,241,.25);}
    .btn-ghost{background:#223043; color:#e6f7f6; border:1px solid var(--stroke)}
    .btn-ghost:hover{background:#2a3b53; box-shadow:0 10px 24px rgba(0,0,0,.25);}

    .list{margin-top:.5rem}
    .item{
      display:grid; grid-template-columns:1fr auto; gap:.6rem; align-items:center;
      padding:.7rem .35rem; border-bottom:1px solid rgba(255,255,255,.06);
    }
    .item-title{font-weight:700; letter-spacing:.2px}
    .item-sub{color:var(--muted); font-size:.95rem}
    .btn-row{display:flex; gap:.45rem}

    .modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1000;
      background:rgba(9,14,22,.55);
      animation:fadeIn .18s ease;
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .sheet{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px; width:min(92vw,560px); padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
    }

    #gate{ position:fixed; inset:0; background:rgba(5,10,18,.92); display:none; align-items:center; justify-content:center; z-index:1500; }
    #gate .panel{ background:var(--panel-2); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:24px; width:min(92vw,520px); }
    #gate ul{margin:.5rem 0 .75rem 1.2rem}
    #weatherBar{ position:fixed; bottom:0; left:0; right:0; text-align:center; padding:.55rem; border-top:1px solid rgba(255,255,255,.08); background:rgba(18,27,41,.92); font-size:.92rem }
  </style>
</head>
<body>
  <div id="app">
    <h1>Plan4Cast</h1>
    <p class="muted" style="margin-top:-2px;">Powered by NASA POWER & Meteomatics API</p>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h2>Login</h2>
      <div class="row">
        <input id="loginUsername" placeholder="Username" autocomplete="off" />
        <input id="loginPin" placeholder="4-digit PIN" maxlength="4" inputmode="numeric" type="password" />
        <button class="btn btn-primary" onclick="login()">Login</button>
        <p id="loginMsg"></p>
        <p class="muted">Don’t have an account? <a href="#" onclick="showSignup()" style="color:var(--teal); text-decoration:none">Sign up</a></p>
      </div>
    </div>

    <!-- SIGNUP -->
    <div id="signupCard" class="card hidden">
      <h2>Sign Up</h2>
      <div class="row">
        <input id="signupUsername" placeholder="Choose username" autocomplete="off" />
        <input id="signupPin" placeholder="4-digit PIN" maxlength="4" inputmode="numeric" type="password" />
        <button class="btn btn-primary" onclick="signup()">Create Account</button>
        <p id="signupMsg"></p>
        <p class="muted">Already have an account? <a href="#" onclick="showLogin()" style="color:var(--teal); text-decoration:none">Login</a></p>
      </div>
    </div>

    <!-- HOME -->
    <div id="homeCard" class="card hidden">
      <div class="header">
        <div>
          <div class="time" id="clock">--:--</div>
          <div class="loc" id="locLine">Locating…</div>
        </div>
        <div class="wx" id="wxNow">Weather: (coming soon)</div>
        <button class="btn btn-primary" onclick="openPlanner('create')">Plan</button>
      </div>

      <h2 style="margin-top:1rem;">Upcoming Events</h2>
      <div id="eventsList" class="list"></div>

      <div style="margin-top:12px; display:flex; justify-content:flex-end;">
        <button class="btn btn-ghost" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- EVENT DETAILS -->
    <div id="eventCard" class="card hidden" style="padding:24px 26px;">
      <button onclick="showHome()" class="btn btn-ghost" style="float:right;">← Back</button>
      <h2 id="eventTitle" style="margin-bottom:4px;">Event Overview</h2>
      <p id="eventSub" class="muted" style="margin-bottom:18px;"></p>

      <!-- Weather summary -->
      <div style="background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
                  border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:16px 18px;
                  margin-bottom:18px; box-shadow:0 4px 14px rgba(0,0,0,.25);">
        <h3 style="color:var(--teal); margin:0 0 6px;">Weather Summary</h3>
        <p id="eventHeadline" style="font-size:1.05rem; margin:0;"></p>
      </div>

      <!-- Recommendations -->
      <div style="background:linear-gradient(180deg,rgba(0,255,255,.03),rgba(255,255,255,.02));
                  border:1px solid rgba(102,252,241,.15); border-radius:14px; padding:18px 20px;
                  box-shadow:inset 0 0 12px rgba(102,252,241,.08);">
        <h3 style="color:var(--mint);margin:0 0 8px;">Recommendations</h3>
        <ul id="eventTips" style="margin:0;padding-left:1.1rem;"></ul>
        <p class="muted" id="eventNote" style="margin-top:12px; font-size:.9rem;"></p>
      </div>
    </div>
  </div>

  <div id="weatherBar">Requesting location permission…</div>

  <script>
    const API_BASE = "";
    let TOKEN = localStorage.getItem("token") || null;
    let currentDateISO = "";
    function hideAll(){ document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden")); }
    function showLogin(){ hideAll(); document.getElementById("loginCard").classList.remove("hidden"); }
    function showSignup(){ hideAll(); document.getElementById("signupCard").classList.remove("hidden"); }
    function showHome(){ hideAll(); document.getElementById("homeCard").classList.remove("hidden"); fetchEvents(); }
    function showEvent(){ hideAll(); document.getElementById("eventCard").classList.remove("hidden"); }

    window.addEventListener("load", () => {
      tickClock(); setInterval(tickClock, 1000);
      ensureGeoPermission();
      if (TOKEN) showHome(); else showLogin();
    });

    async function signup(){
      const username=document.getElementById("signupUsername").value.trim().toLowerCase();
      const pin=document.getElementById("signupPin").value.trim();
      const r=await fetch(`${API_BASE}/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,pin})});
      const data=await r.json();
      if(data.ok){TOKEN=data.token;localStorage.setItem("token",TOKEN);showHome();}
      else document.getElementById("signupMsg").textContent=data.error||"Signup failed";
    }
    async function login(){
      const username=document.getElementById("loginUsername").value.trim().toLowerCase();
      const pin=document.getElementById("loginPin").value.trim();
      const r=await fetch(`${API_BASE}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,pin})});
      const data=await r.json();
      if(data.ok){TOKEN=data.token;localStorage.setItem("token",TOKEN);showHome();}
      else document.getElementById("loginMsg").textContent=data.error||"Login failed";
    }
    function logout(){TOKEN=null;localStorage.removeItem("token");showLogin();}

    function tickClock(){
      const now=new Date(); const hh=now.getHours().toString().padStart(2,"0"); const mm=now.getMinutes().toString().padStart(2,"0");
      document.getElementById("clock").textContent=`${hh}:${mm}`;
    }

    async function ensureGeoPermission(){
      try{
        const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej));
        const {latitude,longitude}=pos.coords;
        window.currentCoords={lat:latitude,lon:longitude};
        document.getElementById("weatherBar").textContent=`Location: (${latitude.toFixed(2)}, ${longitude.toFixed(2)})`;
      }catch(e){document.getElementById("weatherBar").textContent="Location unavailable";}
    }

    async function fetchEvents(){
      const r=await fetch(`/events`,{headers:{Authorization:`Bearer ${TOKEN}`}});const data=await r.json();
      const list=document.getElementById("eventsList");list.innerHTML="";
      if(!Array.isArray(data)||data.length===0){list.innerHTML=`<div class="muted">No events yet — use the <b>Plan</b> button above.</div>`;return;}
      data.forEach(e=>{
        const row=document.createElement("div");row.className="item";
        const left=document.createElement("div");
        left.innerHTML=`<div class="item-title">${e.event_name}</div><div class="item-sub">${e.date}${e.city?" • "+e.city:""}</div>`;
        const btns=document.createElement("div");btns.className="btn-row";
        const b1=document.createElement("button");b1.className="btn btn-primary";b1.textContent="View";b1.onclick=()=>openEventDetails(e);
        btns.appendChild(b1);row.appendChild(left);row.appendChild(btns);list.appendChild(row);
      });
    }

    async function openEventDetails(e){
      document.getElementById("eventTitle").textContent=e.event_name;
      document.getElementById("eventSub").textContent=`${e.date}${e.city?" • "+e.city:""}`;
      const body=e.id?{event_id:e.id}:{event_name:e.event_name,date:e.date,lat:e.lat,lon:e.lon};
      const r=await fetch(`/suggest`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${TOKEN}`},body:JSON.stringify(body)});
      const data=await r.json();

      // pick icon
      const cond=(data.predicted||"").toLowerCase();
      let icon="🌤️";
      if(cond.includes("hot")) icon="☀️";
      else if(cond.includes("wet")||cond.includes("rain")) icon="🌧️";
      else if(cond.includes("wind")) icon="🌬️";
      else if(cond.includes("cool")) icon="❄️";

      document.getElementById("eventHeadline").innerHTML=`${icon} <b>${data.predicted||"—"}</b>`;
      const tipsList=document.getElementById("eventTips");tipsList.innerHTML="";
      (data.advice||[]).forEach(t=>{const li=document.createElement("li");li.textContent=t;tipsList.appendChild(li);});
      document.getElementById("eventNote").textContent=data.note||"";
      showEvent();
    }
  </script>
</body>
</html>
